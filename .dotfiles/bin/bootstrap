#!/bin/bash

set -e

packages=(ansible)

# Detect the OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
else
    echo "Cannot detect OS"
    exit 1
fi

# Install packages based on OS
case $OS in
    "ubuntu")
        sudo apt update
        for package in "${packages[@]}"; do
            if ! command -v "$package" &> /dev/null; then
                sudo DEBIAN_FRONTEND=noninteractive apt install -y "$package" --no-install-recommends
            fi
        done
        ;;
    
    "fedora")
        sudo dnf check-update || true  # dnf check-update exits with 100 if updates are available
        for package in "${packages[@]}"; do
            if ! command -v "$package" &> /dev/null; then
                sudo dnf install -y "$package"
            fi
        done
        ;;
    
    *)
        echo "Unsupported OS: $OS"
        exit 1
        ;;
esac
# Install more recent version of Ansible than the one provided by Ubuntu
# sudo add-apt-repository -y -u ppa:ansible/ansible
# sudo apt update
# sudo DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends ansible

if command -v ansible-galaxy &> /dev/null; then
  ansible-galaxy collection install -r "$HOME/.dotfiles/ansible/requirements.yml"
fi

if command -v ansible &> /dev/null; then
  ansible-playbook "$HOME/.dotfiles/ansible/site.yml"
fi

